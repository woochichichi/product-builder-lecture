<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìŠ¤ë¬´ê³ ê°œ ê²Œì„</title>
    <meta name="description" content="AIì™€ ìŠ¤ë¬´ê³ ê°œ ê²Œì„ì„ ì¦ê²¨ë³´ì„¸ìš”! ë‹¨ì–´ë¥¼ ìƒê°í•˜ë©´ AIê°€ 20ë²ˆì˜ ì§ˆë¬¸ìœ¼ë¡œ ë§ì¶°ë´…ë‹ˆë‹¤.">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --success: #22c55e;
            --danger: #ef4444; --warning: #f59e0b; --bg: #0f172a;
            --card-bg: #1e293b; --text: #f1f5f9; --text-muted: #94a3b8; --border: #334155;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh; display: flex; flex-direction: column;
            align-items: center; padding: 1rem; overflow-x: hidden;
        }
        .container { width: 100%; max-width: 500px; display: flex; flex-direction: column; min-height: calc(100vh - 2rem); }

        /* Header & Tabs */
        .header { text-align: center; padding: 1rem 0; }
        .header h1 { font-size: 1.6rem; background: linear-gradient(135deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .tab { flex: 1; padding: 0.7rem; background: var(--card-bg); border: none; border-radius: 10px; color: var(--text-muted); font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .tab.active { background: var(--primary); color: white; }
        .tab:hover:not(.active) { background: var(--border); }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* How to Play */
        .how-to-play { background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; }
        .how-to-play h3 { color: var(--primary); margin-bottom: 0.6rem; font-size: 0.95rem; }
        .how-to-play p { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.3rem; padding-left: 0.5rem; }

        /* Streak Banner */
        .streak-banner { display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.2)); border: 1px solid rgba(245,158,11,0.4); padding: 0.6rem 1rem; border-radius: 10px; margin-bottom: 1rem; font-size: 0.9rem; }
        .streak-banner .streak { font-size: 1.3rem; font-weight: 700; color: var(--warning); }

        /* Difficulty Selection */
        .difficulty-section { width: 100%; margin-bottom: 1rem; }
        .difficulty-section h3 { color: var(--primary); margin-bottom: 0.6rem; font-size: 0.9rem; }
        .difficulty-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.4rem; }
        .difficulty-option { padding: 0.6rem 0.4rem; background: var(--card-bg); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s; }
        .difficulty-option:hover { border-color: var(--primary); }
        .difficulty-option.selected { border-color: var(--primary); background: rgba(99,102,241,0.1); }
        .difficulty-option .diff-icon { font-size: 1.2rem; }
        .difficulty-option .diff-name { font-size: 0.7rem; font-weight: 600; margin-top: 0.2rem; }
        .difficulty-option .diff-desc { font-size: 0.6rem; color: var(--text-muted); margin-top: 0.1rem; }
        .difficulty-option[title] { cursor: pointer; position: relative; }
        .diff-easy { color: #22c55e; } .diff-normal { color: #3b82f6; }
        .diff-hard { color: #f59e0b; } .diff-expert { color: #ef4444; }

        /* Stats & Badges */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .stat-box { background: var(--card-bg); padding: 0.8rem 0.5rem; border-radius: 10px; text-align: center; }
        .stat-box .value { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .stat-box .label { font-size: 0.65rem; color: var(--text-muted); }

        .badges-row { display: flex; gap: 0.4rem; flex-wrap: wrap; justify-content: center; margin-bottom: 1rem; }
        .badge { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: var(--card-bg); border: 2px solid var(--border); opacity: 0.3; }
        .badge.earned { opacity: 1; border-color: var(--warning); box-shadow: 0 0 8px rgba(245,158,11,0.3); }

        /* Leaderboard */
        .leaderboard { background: var(--card-bg); border-radius: 12px; padding: 1rem; }
        .leaderboard h3 { color: var(--primary); margin-bottom: 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .leaderboard-tabs { display: flex; gap: 0.3rem; margin-bottom: 1rem; }
        .lb-tab { flex: 1; padding: 0.5rem 0.3rem; background: rgba(99,102,241,0.1); border: none; border-radius: 8px; color: var(--text-muted); font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .lb-tab.active { background: var(--primary); color: white; }
        .lb-tab:hover:not(.active) { background: rgba(99,102,241,0.2); }

        /* Leaderboard Table */
        .leaderboard-content { overflow-x: auto; }
        .leaderboard-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .leaderboard-table thead { background: rgba(99,102,241,0.1); }
        .leaderboard-table th { padding: 0.6rem 0.4rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.7rem; white-space: nowrap; }
        .leaderboard-table td { padding: 0.6rem 0.4rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .leaderboard-table tbody tr { transition: all 0.2s; }
        .leaderboard-table tbody tr:hover { background: rgba(99,102,241,0.05); }

        /* Rank Styles */
        .leaderboard-table .rank-cell { font-weight: 700; text-align: center; min-width: 40px; }
        .leaderboard-table tr.rank-gold { background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,165,0,0.1)); }
        .leaderboard-table tr.rank-gold td { color: #ffd700; }
        .leaderboard-table tr.rank-silver { background: linear-gradient(135deg, rgba(192,192,192,0.15), rgba(169,169,169,0.1)); }
        .leaderboard-table tr.rank-silver td { color: #c0c0c0; }
        .leaderboard-table tr.rank-bronze { background: linear-gradient(135deg, rgba(205,127,50,0.15), rgba(139,69,19,0.1)); }
        .leaderboard-table tr.rank-bronze td { color: #cd7f32; }
        .leaderboard-table tr.my-record { background: rgba(99,102,241,0.15); border-left: 3px solid var(--primary); }
        .leaderboard-table tr.my-record td { color: var(--primary); font-weight: 600; }

        /* Badges */
        .diff-badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 10px; font-size: 0.65rem; font-weight: 600; }
        .diff-badge.easy { background: rgba(34,197,94,0.2); color: #22c55e; }
        .diff-badge.normal { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .diff-badge.hard { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .diff-badge.expert { background: rgba(239,68,68,0.2); color: #ef4444; }

        .no-records { text-align: center; color: var(--text-muted); padding: 2rem; font-size: 0.9rem; }
        .loading-spinner { text-align: center; padding: 2rem; color: var(--text-muted); }
        .nickname-display { display: flex; align-items: center; justify-content: space-between; background: rgba(99,102,241,0.1); padding: 0.6rem 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .nickname-display span { font-size: 0.85rem; }
        .nickname-display button { background: none; border: none; color: var(--primary); font-size: 0.8rem; cursor: pointer; }
        .online-count { font-size: 0.75rem; color: var(--success); display: flex; align-items: center; gap: 0.3rem; }
        .online-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Achievements */
        .achievements { margin-top: 1rem; }
        .achievements h3 { color: var(--primary); margin-bottom: 0.8rem; font-size: 1rem; }
        .achievement { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; background: var(--card-bg); border-radius: 10px; margin-bottom: 0.5rem; opacity: 0.5; }
        .achievement.unlocked { opacity: 1; border: 1px solid var(--success); }
        .achievement-icon { font-size: 1.5rem; }
        .achievement-info h4 { font-size: 0.9rem; margin-bottom: 0.2rem; }
        .achievement-info p { font-size: 0.75rem; color: var(--text-muted); }

        /* Game Screen */
        .session-counter { text-align: center; padding: 0.4rem; background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.2)); border-radius: 20px; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--primary); font-weight: 600; }
        .difficulty-display { text-align: center; margin-bottom: 0.5rem; }
        .difficulty-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
        .difficulty-easy { background: rgba(34,197,94,0.2); color: #22c55e; }
        .difficulty-normal { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .difficulty-hard { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .difficulty-expert { background: rgba(239,68,68,0.2); color: #ef4444; }

        /* Timer Display */
        .timer-container { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 1rem; background: var(--card-bg); border-radius: 12px; margin-bottom: 0.8rem; }
        .timer-left { display: flex; align-items: center; gap: 0.5rem; }
        .counter-number { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .counter-text { font-size: 0.8rem; color: var(--text-muted); }
        .game-timer { font-family: monospace; font-size: 1rem; color: var(--text-muted); }

        /* Circular Timer */
        .circular-timer { position: relative; width: 50px; height: 50px; }
        .circular-timer svg { transform: rotate(-90deg); }
        .circular-timer circle { fill: none; stroke-width: 4; }
        .circular-timer .bg { stroke: var(--border); }
        .circular-timer .progress { stroke: var(--primary); stroke-linecap: round; transition: stroke-dashoffset 0.3s; }
        .circular-timer .progress.warning { stroke: var(--warning); }
        .circular-timer .progress.danger { stroke: var(--danger); animation: blink 0.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .circular-timer .time-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.9rem; font-weight: 700; }
        .circular-timer .time-text.danger { color: var(--danger); }

        .progress-bar { height: 5px; background: var(--border); border-radius: 3px; margin-bottom: 0.8rem; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #a855f7); transition: width 0.3s; }

        /* Chat Area */
        .chat-area { flex: 1; background: var(--card-bg); border-radius: 12px; padding: 0.8rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.6rem; margin-bottom: 0.8rem; min-height: 320px; max-height: 400px; }
        .message { max-width: 85%; padding: 0.7rem 1rem; border-radius: 14px; animation: slideIn 0.3s ease; line-height: 1.4; font-size: 0.9rem; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.ai { align-self: flex-start; background: linear-gradient(135deg, #374151, #1f2937); border-bottom-left-radius: 4px; }
        .message.user { align-self: flex-end; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-bottom-right-radius: 4px; }
        .message.system { align-self: center; background: transparent; color: var(--text-muted); font-size: 0.8rem; text-align: center; padding: 0.4rem; }
        
        .typing { display: flex; gap: 4px; padding: 0.8rem; align-self: flex-start; }
        .typing span { width: 7px; height: 7px; background: var(--text-muted); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .typing span:nth-child(1) { animation-delay: 0s; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Buttons */
        .buttons-area { display: flex; flex-direction: column; gap: 0.6rem; }
        .answer-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; }
        .btn { padding: 0.9rem 1rem; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.4rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-yes { background: linear-gradient(135deg, var(--success), #16a34a); color: white; }
        .btn-no { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }
                .btn-large { padding: 1rem; font-size: 1rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(99,102,241,0.4); } 50% { box-shadow: 0 0 0 8px rgba(99,102,241,0); } }
        @keyframes slideUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }

        /* Input Area */
        .input-area { display: flex; flex-direction: column; gap: 0.5rem; }
        .question-input-row { display: flex; gap: 0.5rem; }
        .question-input-row input { flex: 1; padding: 0.8rem; border: 2px solid var(--border); border-radius: 10px; background: var(--card-bg); color: var(--text); font-size: 0.9rem; }
        .question-input-row input:focus { outline: none; border-color: var(--primary); }
        .question-input-row .btn { padding: 0.8rem 1.2rem; white-space: nowrap; }
        .action-row { display: flex; gap: 0.5rem; }
        .action-row .btn { flex: 1; }
        .btn-guess { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; font-weight: 700; }
        .btn-hint { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }

        .game-mode-buttons { display: flex; flex-direction: column; gap: 0.5rem; }
        .btn-challenge { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }

        /* Challenge Banner */
        .challenge-banner { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.2)); border: 2px solid var(--warning); padding: 1.2rem; border-radius: 12px; text-align: center; margin-top: 1rem; animation: glow 2s infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 10px rgba(245,158,11,0.3); } 50% { box-shadow: 0 0 20px rgba(245,158,11,0.6); } }
        .challenge-from { color: var(--warning); font-size: 1.1rem; margin-bottom: 0.3rem; }
        .challenge-msg { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem; }
        .challenge-word-display { background: var(--bg); padding: 0.8rem; border-radius: 8px; margin: 1rem 0; }
        .challenge-word-display .label { font-size: 0.75rem; color: var(--text-muted); }
        .challenge-word-display .word { font-size: 1.5rem; font-weight: 700; color: var(--primary); letter-spacing: 2px; }

        /* Result Screen */
        .result-screen { display: none; flex-direction: column; align-items: center; text-align: center; padding: 1rem; animation: fadeInUp 0.5s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .result-icon { font-size: 3.5rem; margin-bottom: 0.5rem; animation: bounceIn 0.6s ease; }
        @keyframes bounceIn { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .result-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem; }
        .result-title.win { background: linear-gradient(135deg, #22c55e, #16a34a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .result-title.lose { background: linear-gradient(135deg, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .result-subtitle { color: var(--text-muted); margin-bottom: 1rem; font-size: 0.85rem; }

        .badge-earned { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.2)); border: 1px solid rgba(245,158,11,0.4); padding: 0.8rem; border-radius: 10px; margin-bottom: 0.8rem; width: 100%; }
        .badge-earned .badge-icon { font-size: 1.5rem; }
        .badge-earned .badge-text { color: var(--warning); font-weight: 600; font-size: 0.9rem; }

        .result-stats { background: var(--card-bg); padding: 1rem; border-radius: 12px; width: 100%; margin-bottom: 0.8rem; }
        .result-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.6rem; }
        .result-stat { text-align: center; padding: 0.6rem; background: rgba(99,102,241,0.1); border-radius: 10px; }
        .result-stat-icon { font-size: 1.1rem; margin-bottom: 0.2rem; }
        .result-stat-value { font-size: 1rem; font-weight: 700; }
        .result-stat-label { font-size: 0.65rem; color: var(--text-muted); }

        .tomorrow-box { background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border: 1px solid rgba(99,102,241,0.3); padding: 0.8rem; border-radius: 10px; width: 100%; margin-bottom: 0.8rem; }
        .tomorrow-box p { font-size: 0.85rem; color: var(--text-muted); }
        .tomorrow-box .tomorrow-msg { color: var(--primary); font-weight: 600; }

        .share-section { width: 100%; margin-bottom: 0.8rem; }
        .share-section > p { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .share-buttons { display: flex; gap: 0.4rem; }
        .share-btn { flex: 1; padding: 0.6rem; border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .share-btn.twitter { background: #1DA1F2; color: white; }
        .share-btn.kakao { background: #FEE500; color: #000; }
        .share-btn.copy { background: var(--border); color: var(--text); }

        .action-buttons { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; }

        /* Confetti */
        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; overflow: hidden; }
        .confetti { position: absolute; width: 10px; height: 10px; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 1rem; }
        .modal { background: var(--card-bg); padding: 1.5rem; border-radius: 14px; width: 100%; max-width: 380px; }
        .modal h3 { margin-bottom: 0.5rem; }
        .modal p { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem; }
        .confirm-buttons { display: flex; gap: 0.5rem; }
        .confirm-buttons .btn { flex: 1; padding: 0.6rem; font-size: 0.9rem; }
        .modal input[type="text"] { width: 100%; padding: 0.8rem; border: 2px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 1rem; margin-bottom: 0.5rem; }
        .modal input[type="text"]:focus { outline: none; border-color: var(--primary); }
        .modal .input-hint { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; }
        .word-input-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .word-input-section label { display: block; font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--text); }
        .checkbox-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
        .checkbox-row label { font-size: 0.85rem; color: var(--text-muted); }

        .hidden { display: none !important; }
        .chat-area::-webkit-scrollbar { width: 5px; }
        .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        @media (max-width: 400px) {
            .difficulty-options { grid-template-columns: repeat(2, 1fr); }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .leaderboard-table th, .leaderboard-table td { padding: 0.4rem 0.2rem; font-size: 0.7rem; }
            .lb-tab { font-size: 0.6rem; padding: 0.4rem 0.2rem; }
            .diff-badge { font-size: 0.55rem; padding: 0.1rem 0.3rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>AI ìŠ¤ë¬´ê³ ê°œ</h1></div>

        <!-- Tabs -->
        <div class="tabs" id="mainTabs">
            <button class="tab active" onclick="showTab('game')">ğŸ® ê²Œì„</button>
            <button class="tab" onclick="showTab('leaderboard')">ğŸ† ê¸°ë¡</button>
            <button class="tab" onclick="showTab('achievements')">â­ ì—…ì </button>
        </div>

        <!-- Game Tab -->
        <div class="tab-content active" id="gameTab">
            <!-- How to Play -->
            <div class="how-to-play">
                <h3>ğŸ® ê²Œì„ ë°©ë²•</h3>
                <p>1. AIê°€ ë‹¨ì–´ë¥¼ í•˜ë‚˜ ìƒê°í•©ë‹ˆë‹¤</p>
                <p>2. ì˜ˆ/ì•„ë‹ˆì˜¤ ì§ˆë¬¸ì„ í•´ì„œ ì¶”ë¦¬í•˜ì„¸ìš”</p>
                <p>3. ì ì€ ì§ˆë¬¸ìœ¼ë¡œ ë§ì¶œìˆ˜ë¡ ê³ ë“ì !</p>
            </div>

            <!-- Streak Banner -->
            <div class="streak-banner">
                <span>ğŸ”¥ ì—°ì† ì ‘ì†</span>
                <span class="streak" id="dailyStreak">1</span>
                <span>ì¼ì§¸!</span>
            </div>

            <!-- Difficulty -->
            <div class="difficulty-section">
                <h3>ğŸ¯ ë‚œì´ë„ ì„ íƒ</h3>
                <div class="difficulty-options">
                    <div class="difficulty-option selected" data-difficulty="easy" onclick="selectDifficulty('easy')" title="10ë²ˆ ì§ˆë¬¸ | ì´ˆë³´ì ì¶”ì²œ">
                        <div class="diff-icon">ğŸŒ±</div>
                        <div class="diff-name diff-easy">ì‰¬ì›€</div>
                        <div class="diff-desc">10ë²ˆ</div>
                    </div>
                    <div class="difficulty-option" data-difficulty="normal" onclick="selectDifficulty('normal')" title="15ë²ˆ ì§ˆë¬¸ | ì ë‹¹í•œ ë„ì „">
                        <div class="diff-icon">ğŸ¯</div>
                        <div class="diff-name diff-normal">ë³´í†µ</div>
                        <div class="diff-desc">15ë²ˆ</div>
                    </div>
                    <div class="difficulty-option" data-difficulty="hard" onclick="selectDifficulty('hard')" title="20ë²ˆ ì§ˆë¬¸ | ì–´ë ¤ìš´ ë„ì „">
                        <div class="diff-icon">ğŸ”¥</div>
                        <div class="diff-name diff-hard">ì–´ë ¤ì›€</div>
                        <div class="diff-desc">20ë²ˆ</div>
                    </div>
                    <div class="difficulty-option" data-difficulty="expert" onclick="selectDifficulty('expert')" title="25ë²ˆ ì§ˆë¬¸ | ê·¹í•œ ë„ì „">
                        <div class="diff-icon">ğŸ’€</div>
                        <div class="diff-name diff-expert">ì „ë¬¸ê°€</div>
                        <div class="diff-desc">25ë²ˆ</div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-box"><div class="value" id="statTotal">0</div><div class="label">ì´ ê²Œì„</div></div>
                <div class="stat-box"><div class="value" id="statWins">0</div><div class="label">ë‚´ ìŠ¹ë¦¬</div></div>
                <div class="stat-box"><div class="value" id="statBest">-</div><div class="label">ìµœê³ ê¸°ë¡</div></div>
                <div class="stat-box"><div class="value" id="statToday">0</div><div class="label">ì˜¤ëŠ˜</div></div>
            </div>

            <!-- Badges -->
            <div class="badges-row" id="badgesRow">
                <div class="badge" data-badge="easy" title="ì‰¬ì›€">ğŸŒ±</div>
                <div class="badge" data-badge="normal" title="ë³´í†µ">ğŸ¯</div>
                <div class="badge" data-badge="hard" title="ì–´ë ¤ì›€">ğŸ”¥</div>
                <div class="badge" data-badge="expert" title="ì „ë¬¸ê°€">ğŸ’€</div>
                <div class="badge" data-badge="streak3" title="3ì—°ìŠ¹">âš¡</div>
                <div class="badge" data-badge="streak7" title="7ì¼ ì—°ì†">ğŸ“…</div>
                <div class="badge" data-badge="fast" title="1ë¶„ ë‚´">â±ï¸</div>
                <div class="badge" data-badge="perfect" title="5ê²Œì„ ì—°ì†">ğŸ¯</div>
            </div>

            <div class="game-mode-buttons">
                <button class="btn btn-primary btn-large" onclick="confirmStartGame()">ğŸ® í˜¼ì í•˜ê¸°</button>
                <button class="btn btn-challenge btn-large" onclick="showChallengeModal()">ğŸ¯ ì¹œêµ¬ì—ê²Œ ë„ì „ì¥</button>
            </div>

            <!-- Received Challenge Banner -->
            <div class="challenge-banner hidden" id="challengeBanner">
                <div class="challenge-from">ğŸ“© <strong id="challengeFrom">ì¹œêµ¬</strong>ë‹˜ì˜ ë„ì „ì¥!</div>
                <div class="challenge-msg">"ì´ ë‹¨ì–´ ë§ì¶œ ìˆ˜ ìˆì–´?" ğŸ¤”</div>
                <button class="btn btn-primary" onclick="startChallengeGame()">ë„ì „ ìˆ˜ë½!</button>
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div class="tab-content" id="leaderboardTab">
            <div class="nickname-display" id="nicknameDisplay">
                <span>ğŸ‘¤ <strong id="currentNickname">ìµëª…</strong></span>
                <button onclick="showNicknameModal()">ë³€ê²½</button>
            </div>
            <div class="leaderboard">
                <h3>ğŸ† ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ <span class="online-count" id="onlineCount"><span class="online-dot"></span>ì‹¤ì‹œê°„</span></h3>
                <div class="leaderboard-tabs">
                    <button class="lb-tab active" data-tab="global" onclick="switchLeaderboardTab('global')">ğŸŒ ì „ì²´</button>
                    <button class="lb-tab" data-tab="today" onclick="switchLeaderboardTab('today')">ğŸ“… ì˜¤ëŠ˜</button>
                    <button class="lb-tab" data-tab="week" onclick="switchLeaderboardTab('week')">ğŸ“Š ì£¼ê°„</button>
                    <button class="lb-tab" data-tab="mine" onclick="switchLeaderboardTab('mine')">ğŸ‘¤ ë‚´ ê¸°ë¡</button>
                </div>
                <div class="leaderboard-content" id="leaderboardList">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>ë‹‰ë„¤ì„</th>
                                <th>ë‹¨ì–´</th>
                                <th>ì§ˆë¬¸</th>
                                <th>ì‹œê°„</th>
                                <th>ë‚œì´ë„</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr><td colspan="6" class="loading-spinner">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div class="tab-content" id="achievementsTab">
            <div class="achievements">
                <h3>â­ ë„ì „ ê³¼ì œ</h3>
                <div id="achievementsList"></div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="hidden" id="gameScreen">
            <div class="session-counter" id="sessionCounter">ğŸ¯ 1ë²ˆì§¸ ê²Œì„</div>
            <div class="difficulty-display"><span class="difficulty-badge" id="currentDiffBadge">ì‰¬ì›€</span></div>

            <div class="timer-container">
                <div class="timer-left">
                    <span class="counter-text">ì§ˆë¬¸</span>
                    <span class="counter-number" id="qCount">0</span>
                    <span class="counter-text">/ <span id="maxQ">20</span></span>
                </div>
                <div class="game-timer" id="gameTimer">00:00</div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>

            <div class="chat-area" id="chatArea"></div>

            <div class="input-area">
                <div class="question-input-row">
                    <input type="text" id="questionInput" placeholder="ì˜ˆ/ì•„ë‹ˆì˜¤ë¡œ ë‹µí•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100">
                    <button class="btn btn-primary" onclick="askQuestion()" id="askBtn">ì§ˆë¬¸</button>
                </div>
                <div class="action-row">
                    <button class="btn btn-guess" onclick="showGuessModal()" id="guessBtn">ğŸ¯ ë§ì¶”ê¸°</button>
                    <button class="btn btn-hint" onclick="getHint()" id="hintBtn">ğŸ’¡ íŒíŠ¸</button>
                    <button class="btn btn-secondary" onclick="confirmNewGame()">ğŸ”„</button>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div class="result-screen" id="resultScreen">
            <div class="result-icon" id="resultIcon">ğŸ‰</div>
            <div class="result-title" id="resultTitle">AI ìŠ¹ë¦¬!</div>
            <div class="result-subtitle" id="resultSubtitle">AIê°€ ë§ì·„ìŠµë‹ˆë‹¤!</div>

            <div class="badge-earned hidden" id="badgeEarned">
                <span class="badge-icon" id="badgeIcon">ğŸ†</span>
                <span class="badge-text" id="badgeText">ìƒˆ ë°°ì§€!</span>
            </div>

            <div class="result-stats">
                <div class="result-stats-grid">
                    <div class="result-stat"><div class="result-stat-icon">â“</div><div class="result-stat-value" id="resQ">0</div><div class="result-stat-label">ì§ˆë¬¸</div></div>
                    <div class="result-stat"><div class="result-stat-icon">â±ï¸</div><div class="result-stat-value" id="resTime">00:00</div><div class="result-stat-label">ì‹œê°„</div></div>
                    <div class="result-stat"><div class="result-stat-icon">ğŸ“ˆ</div><div class="result-stat-value" id="resDiff"><span class="difficulty-badge">-</span></div><div class="result-stat-label">ë‚œì´ë„</div></div>
                </div>
            </div>

            <div class="tomorrow-box">
                <p>ğŸŒŸ <span class="tomorrow-msg">ë‚´ì¼ ìƒˆë¡œìš´ ì±Œë¦°ì§€ê°€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤!</span></p>
            </div>

            <div class="share-section">
                <p>ê²°ê³¼ ê³µìœ </p>
                <div class="share-buttons">
                    <button class="share-btn twitter" onclick="shareTwitter()">ğ•</button>
                    <button class="share-btn kakao" onclick="shareKakao()">ğŸ’¬</button>
                    <button class="share-btn copy" onclick="copyResult()">ğŸ“‹</button>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary btn-large" onclick="playAgain()">ğŸ® ë‹¤ì‹œ ë„ì „</button>
                <button class="btn btn-secondary" onclick="goToStart()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
            </div>

            <div class="challenge-share-section" id="challengeShareSection" style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(217,119,6,0.1));border:2px solid var(--warning);border-radius:12px;padding:1rem;margin-top:1rem;">
                <p style="font-size:1rem;font-weight:700;color:var(--warning);text-align:center;margin-bottom:0.3rem;" id="challengeTaunt">ğŸ”¥ ë‚˜ëŠ” Në²ˆ ë§Œì— ë§ì·„ë‹¤!</p>
                <p style="font-size:0.85rem;color:var(--text-muted);text-align:center;margin-bottom:0.8rem;">ì¹œêµ¬ëŠ” ë” ë¹¨ë¦¬ ë§ì¶œ ìˆ˜ ìˆì„ê¹Œ? ğŸ˜</p>
                <button class="btn btn-challenge" onclick="challengeFriendWithSameWord()" style="width:100%;">
                    ğŸ“© ë„ì „ì¥ ë³´ë‚´ê¸°
                </button>
            </div>
        </div>
    </div>

    <div class="confetti-container" id="confetti"></div>
    <div class="modal-overlay hidden" id="confirmModal">
        <div class="modal">
            <h3>ğŸ”„ ìƒˆ ê²Œì„</h3><p>í˜„ì¬ ê²Œì„ì„ ì¢…ë£Œí•˜ê³  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°ˆê¹Œìš”?</p>
            <div class="confirm-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">ê³„ì†í•˜ê¸°</button>
                <button class="btn btn-primary" onclick="newGame()">ì²˜ìŒìœ¼ë¡œ</button>
            </div>
        </div>
    </div>

    <!-- Guess Modal -->
    <div class="modal-overlay hidden" id="guessModal">
        <div class="modal">
            <h3>ğŸ¯ ì •ë‹µ ë§ì¶”ê¸°</h3>
            <p>AIê°€ ìƒê°í•œ ë‹¨ì–´ê°€ ë¬´ì—‡ì¼ê¹Œìš”?</p>
            <input type="text" id="guessInput" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="30">
            <div class="input-hint">í‹€ë¦¬ë©´ ì§ˆë¬¸ 2íšŒ ì°¨ê°!</div>
            <div class="confirm-buttons">
                <button class="btn btn-secondary" onclick="closeGuessModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="submitGuess()">ë§ì¶”ê¸°!</button>
            </div>
        </div>
    </div>

    <!-- Challenge Modal -->
    <div class="modal-overlay hidden" id="challengeModal">
        <div class="modal">
            <h3>ğŸ¯ ì¹œêµ¬ì—ê²Œ ë„ì „ì¥ ë³´ë‚´ê¸°</h3>
            <p>ì¹œêµ¬ê°€ ë§ì¶°ì•¼ í•  ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!</p>
            <input type="text" id="challengeWordInput" placeholder="ì˜ˆ: í”¼ì•„ë…¸, ì•„ì´í°, ê°•ì•„ì§€..." maxlength="20">
            <div class="input-hint">ì¹œêµ¬ê°€ ì´ ë‹¨ì–´ë¥¼ ëª‡ ë²ˆ ë§Œì— ë§ì¶”ëŠ”ì§€ ëŒ€ê²°!</div>

            <div class="settings-group" style="margin-top:1rem;">
                <label>ë‚´ ë‹‰ë„¤ì„ (ë„ì „ì¥ì— í‘œì‹œ)</label>
                <input type="text" id="challengeNickInput" placeholder="ë‹‰ë„¤ì„" maxlength="10">
            </div>

            <div class="confirm-buttons">
                <button class="btn btn-secondary" onclick="closeChallengeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="createChallenge()">ë§í¬ ìƒì„±</button>
            </div>
        </div>
    </div>

    <!-- Challenge Link Modal -->
    <div class="modal-overlay hidden" id="challengeLinkModal">
        <div class="modal">
            <h3>ğŸ”— ë„ì „ì¥ ë§í¬ ìƒì„± ì™„ë£Œ!</h3>
            <p>ì•„ë˜ ë§í¬ë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”:</p>
            <div style="background:var(--bg);padding:0.8rem;border-radius:8px;margin:1rem 0;word-break:break-all;font-size:0.8rem;color:var(--primary);" id="challengeLinkDisplay"></div>
            <div class="share-buttons" style="margin-bottom:1rem;">
                <button class="share-btn copy" onclick="copyChallengeLink()" style="flex:2;">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
                <button class="share-btn kakao" onclick="shareKakaoChallenge()">ğŸ’¬</button>
                <button class="share-btn twitter" onclick="shareTwitterChallenge()">ğ•</button>
            </div>
            <button class="btn btn-secondary" onclick="closeChallengeLinkModal()" style="width:100%;">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Start Confirm Modal -->
    <div class="modal-overlay hidden" id="startConfirmModal">
        <div class="modal">
            <h3>ğŸ® ê²Œì„ ì‹œì‘!</h3>
            <p>AIê°€ ë‹¨ì–´ë¥¼ í•˜ë‚˜ ìƒê°í• ê²Œìš”!<br><br>
            ì˜ˆ/ì•„ë‹ˆì˜¤ë¡œ ë‹µí•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì„ í•´ì„œ<br>
            AIê°€ ìƒê°í•œ ë‹¨ì–´ë¥¼ ë§ì¶°ë³´ì„¸ìš”!<br><br>
            <span style="font-size:0.8rem;color:var(--text-muted);">ì ì€ ì§ˆë¬¸ìœ¼ë¡œ ë§ì¶œìˆ˜ë¡ ê³ ë“ì !</span></p>
            <div class="confirm-buttons">
                <button class="btn btn-secondary" onclick="closeStartConfirmModal()">ì ê¹ë§Œìš”</button>
                <button class="btn btn-primary" onclick="closeStartConfirmModal(); startGame();">ì‹œì‘!</button>
            </div>
        </div>
    </div>

    <!-- Nickname Modal -->
    <div class="modal-overlay hidden" id="nicknameModal">
        <div class="modal">
            <h3>ğŸ‘¤ ë‹‰ë„¤ì„ ì„¤ì •</h3>
            <p>ë¦¬ë”ë³´ë“œì— í‘œì‹œë  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ (2-10ì)" maxlength="10">
            <div class="input-hint">í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥</div>
            <div class="confirm-buttons">
                <button class="btn btn-secondary" onclick="closeNicknameModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveNickname()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Score Registration Modal -->
    <div class="modal-overlay hidden" id="scoreModal">
        <div class="modal">
            <h3>ğŸ† ê¸°ë¡ ë“±ë¡</h3>
            <p>ì¶•í•˜í•©ë‹ˆë‹¤! ê¸°ë¡ì„ ë¦¬ë”ë³´ë“œì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="word-input-section">
                <div class="checkbox-row">
                    <input type="checkbox" id="saveToLeaderboard" checked>
                    <label for="saveToLeaderboard">ë¦¬ë”ë³´ë“œì— ê³µê°œ</label>
                </div>
            </div>
            <div class="confirm-buttons">
                <button class="btn btn-secondary" onclick="closeScoreModal()">ê±´ë„ˆë›°ê¸°</button>
                <button class="btn btn-primary" onclick="submitScore()">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ====== API ì„¤ì • (localStorage ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’) ======
        const DEFAULT_API_URL = '/api/twenty-questions';
        const storedWorkerUrl = localStorage.getItem('tq_worker_url');
        const WORKER_URL = (storedWorkerUrl && storedWorkerUrl.includes('api')) ? storedWorkerUrl : DEFAULT_API_URL;
        const SUPABASE_URL = localStorage.getItem('tq_supabase_url') || 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = localStorage.getItem('tq_supabase_key') || 'YOUR_SUPABASE_ANON_KEY';
        let supabaseClient = null;
        let leaderboardSubscription = null;

        // ====== ìºì‹œ ì„¤ì • ======
        const CACHE_DURATION = 5 * 60 * 1000; // 5ë¶„
        const CACHE_KEYS = {
            global: 'lb_cache_global',
            today: 'lb_cache_today',
            week: 'lb_cache_week',
            time: 'lb_cache_time'
        };

        function getCache(type) {
            const cached = localStorage.getItem(CACHE_KEYS[type]);
            const cacheTime = localStorage.getItem(CACHE_KEYS.time + '_' + type);

            if (cached && cacheTime) {
                const age = Date.now() - parseInt(cacheTime);
                if (age < CACHE_DURATION) {
                    console.log('ğŸ“¦ ìºì‹œ ì‚¬ìš©:', type);
                    return JSON.parse(cached);
                }
            }
            return null;
        }

        function setCache(type, data) {
            localStorage.setItem(CACHE_KEYS[type], JSON.stringify(data));
            localStorage.setItem(CACHE_KEYS.time + '_' + type, Date.now().toString());
            console.log('ğŸ’¾ ìºì‹œ ì €ì¥:', type);
        }

        function clearAllCache() {
            Object.values(CACHE_KEYS).forEach(key => {
                localStorage.removeItem(key);
                localStorage.removeItem(key + '_global');
                localStorage.removeItem(key + '_today');
                localStorage.removeItem(key + '_week');
            });
            console.log('ğŸ—‘ï¸ ìºì‹œ ì‚­ì œ');
        }

        // Supabase ì´ˆê¸°í™”
        function initSupabase() {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                console.warn('âš ï¸ Supabase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œì»¬ ë¦¬ë”ë³´ë“œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                return false;
            }
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('âœ… Supabase ì—°ê²° ì™„ë£Œ');
                return true;
            } catch (e) {
                console.error('âŒ Supabase ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
                return false;
            }
        }

        // ë¦¬ë”ë³´ë“œì— ê¸°ë¡ ì €ì¥
        async function saveToSupabase(score) {
            if (!supabaseClient) return false;
            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .insert([{
                        nickname: score.nickname,
                        word: score.word || 'ë¹„ê³µê°œ',
                        questions: score.questions,
                        time_seconds: score.time,
                        difficulty: score.difficulty
                    }])
                    .select();

                if (error) throw error;

                // ìºì‹œ ë¬´íš¨í™”
                clearAllCache();

                console.log('âœ… ê¸°ë¡ ì €ì¥ ì™„ë£Œ:', data);
                return true;
            } catch (error) {
                console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // ì „ì²´ ë¦¬ë”ë³´ë“œ ì¡°íšŒ (ìºì‹œ ì ìš©)
        async function loadGlobalLeaderboard() {
            if (!supabaseClient) {
                renderLocalLeaderboard();
                return;
            }

            // ìºì‹œ í™•ì¸
            const cached = getCache('global');
            if (cached) {
                displaySupabaseLeaderboard(cached);
                return;
            }

            showLeaderboardLoading();
            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .order('questions', { ascending: true })
                    .order('time_seconds', { ascending: true })
                    .limit(100);

                if (error) throw error;
                setCache('global', data);
                displaySupabaseLeaderboard(data);
            } catch (error) {
                console.error('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                renderLocalLeaderboard();
            }
        }

        // ì˜¤ëŠ˜ì˜ ë¦¬ë”ë³´ë“œ (ìºì‹œ ì ìš©)
        async function loadTodayLeaderboard() {
            if (!supabaseClient) {
                renderLocalLeaderboard();
                return;
            }

            // ìºì‹œ í™•ì¸
            const cached = getCache('today');
            if (cached) {
                displaySupabaseLeaderboard(cached);
                return;
            }

            showLeaderboardLoading();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .gte('created_at', today.toISOString())
                    .order('questions', { ascending: true })
                    .order('time_seconds', { ascending: true })
                    .limit(50);

                if (error) throw error;
                setCache('today', data);
                displaySupabaseLeaderboard(data);
            } catch (error) {
                console.error('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                renderLocalLeaderboard();
            }
        }

        // ì£¼ê°„ ë¦¬ë”ë³´ë“œ (ìºì‹œ ì ìš©)
        async function loadWeeklyLeaderboard() {
            if (!supabaseClient) {
                renderLocalLeaderboard();
                return;
            }

            // ìºì‹œ í™•ì¸
            const cached = getCache('week');
            if (cached) {
                displaySupabaseLeaderboard(cached);
                return;
            }

            showLeaderboardLoading();
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);

            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .gte('created_at', weekAgo.toISOString())
                    .order('questions', { ascending: true })
                    .order('time_seconds', { ascending: true })
                    .limit(50);

                if (error) throw error;
                setCache('week', data);
                displaySupabaseLeaderboard(data);
            } catch (error) {
                console.error('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                renderLocalLeaderboard();
            }
        }

        // ë‚´ ê¸°ë¡ë§Œ ì¡°íšŒ
        async function loadMyRecords() {
            const myNickname = localStorage.getItem('tq_nickname');
            if (!myNickname) {
                showNicknameModal();
                return;
            }
            if (!supabaseClient) {
                renderLocalLeaderboard();
                return;
            }
            showLeaderboardLoading();

            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .eq('nickname', myNickname)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;
                displaySupabaseLeaderboard(data, true);
            } catch (error) {
                console.error('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                renderLocalLeaderboard();
            }
        }

        // ì‹¤ì‹œê°„ êµ¬ë…
        function subscribeToLeaderboard() {
            if (!supabaseClient) return;

            leaderboardSubscription = supabaseClient
                .channel('leaderboard-changes')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'leaderboard'
                }, (payload) => {
                    console.log('ğŸ”„ ìƒˆ ê¸°ë¡ ì¶”ê°€ë¨!', payload.new);

                    // ìºì‹œ ë¬´íš¨í™”
                    clearAllCache();

                    // í˜„ì¬ í™œì„± íƒ­ì— ë”°ë¼ ìƒˆë¡œê³ ì¹¨
                    const activeTab = document.querySelector('.sub-tab.active');
                    if (activeTab) {
                        switchLeaderboardTab(activeTab.dataset.tab);
                    }
                })
                .subscribe();
        }

        // ë¦¬ë”ë³´ë“œ í‘œì‹œ (í…Œì´ë¸” í˜•ì‹)
        function displaySupabaseLeaderboard(scores, isMyRecords = false) {
            const tbody = document.getElementById('leaderboard-body');
            const myNickname = localStorage.getItem('tq_nickname');

            if (!scores || scores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-records">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</td></tr>';
                return;
            }

            tbody.innerHTML = scores.map((score, i) => {
                const rank = i + 1;
                const isMine = score.nickname === myNickname;

                let rowClass = '';
                if (rank === 1) rowClass = 'rank-gold';
                else if (rank === 2) rowClass = 'rank-silver';
                else if (rank === 3) rowClass = 'rank-bronze';
                if (isMine) rowClass += ' my-record';

                return `<tr class="${rowClass}">
                    <td class="rank-cell">${getRankIcon(rank)}</td>
                    <td>${escapeHtml(score.nickname)}${isMine ? ' ğŸ‘ˆ' : ''}</td>
                    <td>${escapeHtml(score.word)}</td>
                    <td><strong>${score.questions}</strong>ë²ˆ</td>
                    <td>${formatTimeFromSeconds(score.time_seconds)}</td>
                    <td>${getDifficultyBadge(score.difficulty)}</td>
                </tr>`;
            }).join('');
        }

        function getDifficultyBadge(difficulty) {
            const badges = {
                'easy': '<span class="diff-badge easy">ì‰¬ì›€</span>',
                'normal': '<span class="diff-badge normal">ë³´í†µ</span>',
                'hard': '<span class="diff-badge hard">ì–´ë ¤ì›€</span>',
                'expert': '<span class="diff-badge expert">ì „ë¬¸ê°€</span>'
            };
            return badges[difficulty] || difficulty;
        }

        function showLeaderboardLoading() {
            const tbody = document.getElementById('leaderboard-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading-spinner">ë¡œë”© ì¤‘...</td></tr>';
            }
        }

        function getRankIcon(rank) {
            if (rank === 1) return 'ğŸ‘‘';
            if (rank === 2) return 'ğŸ¥ˆ';
            if (rank === 3) return 'ğŸ¥‰';
            return rank;
        }

        function formatTimeFromSeconds(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
            if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}ì‹œê°„ ì „`;
            if (diffMins < 10080) return `${Math.floor(diffMins / 1440)}ì¼ ì „`;

            return date.toLocaleDateString('ko-KR');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // íƒ­ ì „í™˜
        function switchLeaderboardTab(tabType) {
            document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.lb-tab[data-tab="${tabType}"]`).classList.add('active');

            switch(tabType) {
                case 'global': loadGlobalLeaderboard(); break;
                case 'today': loadTodayLeaderboard(); break;
                case 'week': loadWeeklyLeaderboard(); break;
                case 'mine': loadMyRecords(); break;
            }
        }

        // ë‹‰ë„¤ì„ ê´€ë ¨
        function showNicknameModal() {
            document.getElementById('nicknameModal').classList.remove('hidden');
            document.getElementById('nicknameInput').value = localStorage.getItem('tq_nickname') || '';
            document.getElementById('nicknameInput').focus();
        }

        function closeNicknameModal() {
            document.getElementById('nicknameModal').classList.add('hidden');
        }

        function saveNickname() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            if (!nickname || nickname.length < 2 || nickname.length > 10) {
                alert('ë‹‰ë„¤ì„ì€ 2-10ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!/^[ê°€-í£a-zA-Z0-9]+$/.test(nickname)) {
                alert('í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            localStorage.setItem('tq_nickname', nickname);
            updateNicknameDisplay();
            closeNicknameModal();
        }

        function updateNicknameDisplay() {
            const nickname = localStorage.getItem('tq_nickname') || 'ìµëª…';
            document.getElementById('currentNickname').textContent = nickname;
        }

        // ì ìˆ˜ ë“±ë¡ ëª¨ë‹¬
        function showScoreModal() {
            document.getElementById('scoreModal').classList.remove('hidden');
            document.getElementById('wordInput').value = '';
            document.getElementById('saveToLeaderboard').checked = true;
        }

        function closeScoreModal() {
            document.getElementById('scoreModal').classList.add('hidden');
        }

        async function submitScore() {
            const savePublic = document.getElementById('saveToLeaderboard').checked;
            const word = secretWord || 'ë¹„ê³µê°œ';

            let nickname = localStorage.getItem('tq_nickname');
            if (!nickname) {
                nickname = 'ìµëª…' + Math.floor(Math.random() * 10000);
                localStorage.setItem('tq_nickname', nickname);
                updateNicknameDisplay();
            }

            const score = {
                nickname: nickname,
                word: word,
                questions: qCount,
                time: getGameSec(),
                difficulty: difficulty
            };

            // ë¡œì»¬ ì €ì¥
            data.leaderboard.push({
                ...score,
                date: new Date().toLocaleDateString(),
                time: getGameTime(),
                mine: true
            });
            data.leaderboard.sort((a, b) => a.questions - b.questions);
            data.leaderboard = data.leaderboard.slice(0, 20);
            save();

            // Supabaseì— ì €ì¥ (ê³µê°œ ì„ íƒ ì‹œ)
            if (savePublic && supabaseClient) {
                const success = await saveToSupabase(score);
                if (success) {
                    showSuccessToast('ğŸ† ë¦¬ë”ë³´ë“œì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
            }

            closeScoreModal();
            renderLeaderboard();
        }

        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
                background: var(--success); color: white; padding: 0.8rem 1.5rem;
                border-radius: 10px; font-weight: 600; z-index: 1000; animation: slideUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ====== Challenge Mode ======
        function showChallengeModal() {
            document.getElementById('challengeModal').classList.remove('hidden');
            document.getElementById('challengeWordInput').value = '';
            document.getElementById('challengeNickInput').value = localStorage.getItem('tq_nickname') || '';
            document.getElementById('challengeWordInput').focus();
        }

        function closeChallengeModal() {
            document.getElementById('challengeModal').classList.add('hidden');
        }

        function createChallenge() {
            const word = document.getElementById('challengeWordInput').value.trim();
            const nick = document.getElementById('challengeNickInput').value.trim() || 'ìµëª…';

            if (!word || word.length < 1) {
                alert('ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // ë‹‰ë„¤ì„ ì €ì¥
            localStorage.setItem('tq_nickname', nick);
            updateNicknameDisplay();

            // ë§í¬ ìƒì„± (Base64 ì¸ì½”ë”©)
            const encoded = btoa(encodeURIComponent(JSON.stringify({ w: word, f: nick, d: difficulty })));
            challengeLink = `${window.location.origin}${window.location.pathname}?c=${encoded}`;

            closeChallengeModal();
            showChallengeLinkModal();
        }

        function showChallengeLinkModal() {
            document.getElementById('challengeLinkModal').classList.remove('hidden');
            document.getElementById('challengeLinkDisplay').textContent = challengeLink;
        }

        function closeChallengeLinkModal() {
            document.getElementById('challengeLinkModal').classList.add('hidden');
        }

        function copyChallengeLink() {
            navigator.clipboard.writeText(challengeLink).then(() => {
                showSuccessToast('ğŸ“‹ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(() => {
                alert('ë³µì‚¬ ì‹¤íŒ¨. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            });
        }

        function shareKakaoChallenge() {
            copyChallengeLink();
            alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
        }

        function shareTwitterChallenge() {
            const text = `ğŸ¯ AI ìŠ¤ë¬´ê³ ê°œ ë„ì „ì¥ì´ ë„ì°©í–ˆì–´ìš”! ì´ ë‹¨ì–´ ë§ì¶œ ìˆ˜ ìˆì–´?`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(challengeLink)}`, '_blank');
        }

        let challengerScore = null; // ë„ì „ìì˜ ì§ˆë¬¸ ìˆ˜

        function checkChallengeUrl() {
            const params = new URLSearchParams(window.location.search);
            const c = params.get('c');

            if (c) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(c)));
                    challengeWord = decoded.w;
                    challengeFrom = decoded.f || 'ì¹œêµ¬';
                    difficulty = decoded.d || 'easy';
                    challengerScore = decoded.q || null;
                    challengeMode = true;

                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('challengeBanner').classList.remove('hidden');
                    document.getElementById('challengeFrom').textContent = challengeFrom;

                    // ë„ì „ì ì ìˆ˜ í‘œì‹œ
                    if (challengerScore) {
                        document.querySelector('.challenge-msg').innerHTML =
                            `"ì´ ë‹¨ì–´ ${challengerScore}ë²ˆ ì•ˆì— ë§ì¶œ ìˆ˜ ìˆì–´?" ğŸ¤”`;
                    }

                    document.querySelector('.game-mode-buttons').style.display = 'none';

                    // ë‚œì´ë„ ì„ íƒ ì—…ë°ì´íŠ¸
                    selectDifficulty(difficulty);

                    // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±° (ìƒˆë¡œê³ ì¹¨í•´ë„ ë‹¤ì‹œ ì•ˆ ëœ¨ê²Œ)
                    window.history.replaceState({}, '', window.location.pathname);

                } catch (e) {
                    console.error('Invalid challenge link:', e);
                }
            }
        }

        function startChallengeGame() {
            startGame();
        }

        const DIFF = {
            easy: { max: 20, name: 'ì‰¬ì›€', cls: 'easy', icon: 'ğŸŒ±', desc: 'ì¼ìƒ ë‹¨ì–´' },
            normal: { max: 20, name: 'ë³´í†µ', cls: 'normal', icon: 'ğŸ¯', desc: 'ë™ë¬¼/ìì—°' },
            hard: { max: 20, name: 'ì–´ë ¤ì›€', cls: 'hard', icon: 'ğŸ”¥', desc: 'ìœ ëª…ì¸/ì¥ì†Œ' },
            expert: { max: 20, name: 'ì „ë¬¸ê°€', cls: 'expert', icon: 'ğŸ’€', desc: 'ì¶”ìƒ ê°œë…' }
        };

        const ACHIEVEMENTS = [
            { id: 'first', name: 'ì²« ìŠ¹ë¦¬', desc: 'ì²˜ìŒìœ¼ë¡œ AIë¥¼ ì´ê¸°ì„¸ìš”', icon: 'ğŸ¯' },
            { id: 'fast10', name: 'ìŠ¤í”¼ë“œëŸ¬ë„ˆ', desc: '10ë²ˆ ì•ˆì— AI ë§‰ê¸°', icon: 'âš¡' },
            { id: 'streak3', name: '3ì—°ìŠ¹', desc: 'ì—°ì† 3ë²ˆ ìŠ¹ë¦¬', icon: 'ğŸ”¥' },
            { id: 'streak7day', name: '7ì¼ ì—°ì†', desc: '7ì¼ ì—°ì† ì ‘ì†', icon: 'ğŸ“…' },
            { id: 'play5', name: 'ì—´ì • ê²Œì´ë¨¸', desc: '5ê²Œì„ ì—°ì† í”Œë ˆì´', icon: 'ğŸ®' },
            { id: 'allDiff', name: 'ë§ˆìŠ¤í„°', desc: 'ëª¨ë“  ë‚œì´ë„ í´ë¦¬ì–´', icon: 'ğŸ‘‘' }
        ];

        // State
        let qCount = 0, history = [], gameOver = false, difficulty = 'easy', maxQ = 20;
        let sessionNum = 1;
        let gameStart = null, gameInterval = null;
        let secretWord = null; // AIê°€ ìƒê°í•œ ë‹¨ì–´
        let isAsking = false; // ì§ˆë¬¸ ì²˜ë¦¬ ì¤‘

        // Challenge Mode State
        let challengeMode = false;
        let challengeWord = null;
        let challengeFrom = null;
        let challengeLink = null;

        // ë‹¨ì–´ ëª©ë¡ (ì¹´í…Œê³ ë¦¬ë³„)
        const WORD_LISTS = {
            easy: ['ì‚¬ê³¼','ë°”ë‚˜ë‚˜','ê³ ì–‘ì´','ê°•ì•„ì§€','ìë™ì°¨','ë¹„í–‰ê¸°','í”¼ì•„ë…¸','ê¸°íƒ€','ì¶•êµ¬','ë†êµ¬','í–„ë²„ê±°','í”¼ì','ì»´í“¨í„°','íœ´ëŒ€í°','í…”ë ˆë¹„ì „','ëƒ‰ì¥ê³ ','ìš°ì‚°','ê°€ë°©','ì‹ ë°œ','ëª¨ì','ì—°í•„','ì±…','ì˜ì','í…Œì´ë¸”','ì¹¨ëŒ€'],
            normal: ['ì½”ë¼ë¦¬','ê¸°ë¦°','í­ê·„','ëŒê³ ë˜','í•´íŒŒë¦¬','ë¬´ì§€ê°œ','íƒœì–‘','ë‹¬','ë³„','êµ¬ë¦„','ë²ˆê°œ','í™”ì‚°','ë°”ë‹¤','ì‚°','ê°•','ë‚˜ë¬´','ê½ƒ','ë‚˜ë¹„','ë²Œ','ê°œë¯¸','ê±°ë¯¸','ë±€','ì•…ì–´','ìƒì–´','ê³ ë˜'],
            hard: ['ì—í íƒ‘','í”¼ë¼ë¯¸ë“œ','ë§Œë¦¬ì¥ì„±','ììœ ì˜ì—¬ì‹ ìƒ','ì½œë¡œì„¸ì›€','ë¹…ë²¤','íƒ€ì§€ë§ˆí• ','ì˜¤í˜ë¼í•˜ìš°ìŠ¤','ì•„ì¸ìŠˆíƒ€ì¸','ë‰´í„´','ì—ë””ìŠ¨','ëª¨ì°¨ë¥´íŠ¸','í”¼ì¹´ì†Œ','ì…°ìµìŠ¤í”¼ì–´','í´ë ˆì˜¤íŒŒíŠ¸ë¼','ë‚˜í´ë ˆì˜¹','ë§ì»¨','ê°„ë””','ë§ˆí‹´ë£¨í„°í‚¹','ìŠ¤í‹°ë¸Œì¡ìŠ¤'],
            expert: ['ì–‘ìì—­í•™','ìƒëŒ€ì„±ì´ë¡ ','ë¸”ë™í™€','DNA','ê´‘í•©ì„±','ì§„í™”ë¡ ','ë¯¼ì£¼ì£¼ì˜','ìë³¸ì£¼ì˜','ë¥´ë„¤ìƒìŠ¤','ì‚°ì—…í˜ëª…','ì„¸ê³„ëŒ€ì „','ëƒ‰ì „','ì¸í„°ë„·','ì¸ê³µì§€ëŠ¥','ë¸”ë¡ì²´ì¸','ë©”íƒ€ë²„ìŠ¤','ì•”í˜¸í™”í','ìœ ì „ê³µí•™','ë‚˜ë…¸ê¸°ìˆ ','ìš°ì£¼íƒì‚¬']
        };

        // Data
        let data = JSON.parse(localStorage.getItem('tq_data')) || {
            total: 0, wins: 0, aiWins: 0, badges: [], streak: 0, bestQ: null, bestTime: null,
            diffClears: {easy:0,normal:0,hard:0,expert:0}, leaderboard: [], achievements: [],
            lastPlay: null, dailyStreak: 0, todayGames: 0, consecutiveGames: 0
        };

        // Init
        function init() {
            checkDaily();
            updateUI();
            updateNicknameDisplay();

            // ë„ì „ì¥ URL ì²´í¬
            checkChallengeUrl();

            // Supabase ì´ˆê¸°í™”
            const supabaseReady = initSupabase();
            if (supabaseReady) {
                subscribeToLeaderboard();
            }

            renderLeaderboard();
            renderAchievements();
        }

        function checkDaily() {
            const today = new Date().toDateString();
            if (data.lastPlay !== today) {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                if (data.lastPlay === yesterday.toDateString()) {
                    data.dailyStreak++;
                    if (data.dailyStreak >= 7 && !data.badges.includes('streak7')) {
                        data.badges.push('streak7');
                        if (!data.achievements.includes('streak7day')) data.achievements.push('streak7day');
                    }
                } else {
                    data.dailyStreak = 1;
                }
                data.todayGames = 0;
                data.lastPlay = today;
                save();
            }
        }

        function updateUI() {
            document.getElementById('dailyStreak').textContent = data.dailyStreak;
            document.getElementById('statTotal').textContent = data.total;
            document.getElementById('statWins').textContent = data.wins;
            document.getElementById('statBest').textContent = data.bestQ ? data.bestQ + 'ë²ˆ' : '-';
            document.getElementById('statToday').textContent = data.todayGames;

            data.badges.forEach(b => {
                const el = document.querySelector(`[data-badge="${b}"]`);
                if (el) el.classList.add('earned');
            });
        }

        function save() { localStorage.setItem('tq_data', JSON.stringify(data)); }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', ['game','leaderboard','achievements'][i] === tab);
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function selectDifficulty(d) {
            difficulty = d;
            maxQ = DIFF[d].max;
            document.querySelectorAll('.difficulty-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`[data-difficulty="${d}"]`).classList.add('selected');
        }

        function renderLeaderboard() {
            // Supabaseê°€ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ ë¡œë“œ
            if (supabaseClient) {
                loadGlobalLeaderboard();
                return;
            }
            // ë¡œì»¬ ë¦¬ë”ë³´ë“œ í‘œì‹œ
            renderLocalLeaderboard();
        }

        function renderLocalLeaderboard() {
            const tbody = document.getElementById('leaderboard-body');
            if (!data.leaderboard.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-records">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</td></tr>';
                return;
            }
            const myNickname = localStorage.getItem('tq_nickname');
            tbody.innerHTML = data.leaderboard.slice(0, 10).map((r, i) => {
                const rank = i + 1;
                const isMine = r.mine || r.nickname === myNickname;
                const diff = r.diff || r.difficulty;

                let rowClass = '';
                if (rank === 1) rowClass = 'rank-gold';
                else if (rank === 2) rowClass = 'rank-silver';
                else if (rank === 3) rowClass = 'rank-bronze';
                if (isMine) rowClass += ' my-record';

                return `<tr class="${rowClass}">
                    <td class="rank-cell">${getRankIcon(rank)}</td>
                    <td>${escapeHtml(r.nickname || 'ë‚˜')}${isMine ? ' ğŸ‘ˆ' : ''}</td>
                    <td>${escapeHtml(r.word || 'ë¹„ê³µê°œ')}</td>
                    <td><strong>${r.questions}</strong>ë²ˆ</td>
                    <td>${r.time || formatTimeFromSeconds(r.timeSeconds || 0)}</td>
                    <td>${getDifficultyBadge(diff)}</td>
                </tr>`;
            }).join('');
        }

        function renderAchievements() {
            const list = document.getElementById('achievementsList');
            list.innerHTML = ACHIEVEMENTS.map(a => `
                <div class="achievement${data.achievements.includes(a.id)?' unlocked':''}">
                    <div class="achievement-icon">${a.icon}</div>
                    <div class="achievement-info"><h4>${a.name}</h4><p>${a.desc}</p></div>
                </div>
            `).join('');
        }

        // Game
        function startGame() {
            document.getElementById('gameTab').classList.add('hidden');
            document.getElementById('mainTabs').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('resultScreen').style.display = 'none';

            // ë‹¨ì–´ ì„ íƒ (ì±Œë¦°ì§€ ëª¨ë“œë©´ ì±Œë¦°ì§€ ë‹¨ì–´ ì‚¬ìš©)
            if (challengeMode && challengeWord) {
                secretWord = challengeWord;
            } else {
                const words = WORD_LISTS[difficulty];
                secretWord = words[Math.floor(Math.random() * words.length)];
            }

            maxQ = 20;
            document.getElementById('maxQ').textContent = maxQ;
            const cfg = DIFF[difficulty];
            document.getElementById('currentDiffBadge').textContent = cfg.name;
            document.getElementById('currentDiffBadge').className = `difficulty-badge difficulty-${cfg.cls}`;
            document.getElementById('sessionCounter').textContent = `ğŸ¯ ${sessionNum}ë²ˆì§¸ ê²Œì„`;

            resetGame();
            startGameTimer();
            showGameStart();
        }

        function resetGame() {
            qCount = 0; history = []; gameOver = false; isAsking = false; hintCount = 0;
            document.getElementById('chatArea').innerHTML = '';
            document.getElementById('questionInput').value = '';
            document.getElementById('questionInput').disabled = false;
            document.getElementById('askBtn').disabled = false;
            document.getElementById('guessBtn').disabled = false;
            document.getElementById('hintBtn').disabled = false;
            updateQ();
        }

        function showGameStart() {
            if (challengeMode) {
                addMsg(`ğŸ“© ${challengeFrom}ë‹˜ì˜ ë„ì „ì¥! ì´ ë‹¨ì–´ë¥¼ ë§ì¶°ë³´ì„¸ìš”!`, 'system');
            } else {
                addMsg(`ğŸ¤” ì œê°€ ë‹¨ì–´ë¥¼ í•˜ë‚˜ ìƒê°í–ˆì–´ìš”! (${DIFF[difficulty].desc})`, 'ai');
            }
            addMsg('ì˜ˆ/ì•„ë‹ˆì˜¤ë¡œ ë‹µí•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”!', 'system');
            document.getElementById('questionInput').focus();
        }

        function updateQ() {
            document.getElementById('qCount').textContent = qCount;
            document.getElementById('progressBar').style.width = `${(qCount/maxQ)*100}%`;

            // ì§ˆë¬¸ ë‹¤ ì“°ë©´ ê²Œì„ ì˜¤ë²„
            if (qCount >= maxQ && !gameOver) {
                endGame(false);
            }
        }

        // Timers
        function startGameTimer() {
            gameStart = Date.now();
            gameInterval = setInterval(() => {
                const s = Math.floor((Date.now() - gameStart) / 1000);
                document.getElementById('gameTimer').textContent = `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            }, 1000);
        }

        function stopGameTimer() { if (gameInterval) { clearInterval(gameInterval); gameInterval = null; } }
        function getGameTime() { return document.getElementById('gameTimer').textContent; }
        function getGameSec() { return Math.floor((Date.now() - gameStart) / 1000); }

        // Messages
        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            if (type === 'ai' || type === 'system') {
                div.innerHTML = text;
            } else {
                div.textContent = text;
            }
            document.getElementById('chatArea').appendChild(div);
            document.getElementById('chatArea').scrollTop = 99999;
        }

        function showTyping() {
            const div = document.createElement('div');
            div.className = 'typing'; div.id = 'typing';
            div.innerHTML = '<span></span><span></span><span></span>';
            document.getElementById('chatArea').appendChild(div);
            document.getElementById('chatArea').scrollTop = 99999;
        }

        function hideTyping() { const t = document.getElementById('typing'); if (t) t.remove(); }

        function disableInputs() {
            document.getElementById('questionInput').disabled = true;
            document.getElementById('askBtn').disabled = true;
            document.getElementById('guessBtn').disabled = true;
            document.getElementById('hintBtn').disabled = true;
        }

        function enableInputs() {
            document.getElementById('questionInput').disabled = false;
            document.getElementById('askBtn').disabled = false;
            document.getElementById('guessBtn').disabled = false;
            document.getElementById('hintBtn').disabled = false;
            document.getElementById('questionInput').focus();
        }

        // Game Flow - ìœ ì €ê°€ ì§ˆë¬¸í•˜ê¸°
        async function askQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();

            if (!question || isAsking || gameOver) return;
            if (qCount >= maxQ) {
                addMsg('ì§ˆë¬¸ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤!', 'system');
                return;
            }

            isAsking = true;
            disableInputs();
            input.value = '';

            addMsg(question, 'user');
            history.push({ role: 'user', content: question });
            qCount++;
            updateQ();

            showTyping();
            try {
                const res = await callAI(question);
                hideTyping();
                addMsg(res, 'ai');
                history.push({ role: 'ai', content: res });
            } catch (e) {
                hideTyping();
                addMsg('âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.', 'system');
                qCount--; // ì§ˆë¬¸ ë³µêµ¬
                updateQ();
            }
            isAsking = false;
            enableInputs();
        }

        // ì •ë‹µ ë§ì¶”ê¸° ëª¨ë‹¬
        function showGuessModal() {
            document.getElementById('guessModal').classList.remove('hidden');
            document.getElementById('guessInput').value = '';
            document.getElementById('guessInput').focus();
        }

        function closeGuessModal() {
            document.getElementById('guessModal').classList.add('hidden');
        }

        async function submitGuess() {
            const guess = document.getElementById('guessInput').value.trim();
            if (!guess) return;

            closeGuessModal();
            addMsg(`ğŸ¯ "${guess}"`, 'user');

            // ì •ë‹µ ì²´í¬
            const isCorrect = normalizeWord(guess) === normalizeWord(secretWord);

            if (isCorrect) {
                addMsg(`ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! "<strong>${secretWord}</strong>"`, 'ai');
                endGame(true);
            } else {
                qCount += 2; // í‹€ë¦¬ë©´ 2íšŒ ì°¨ê°
                updateQ();
                addMsg(`âŒ í‹€ë ¸ìŠµë‹ˆë‹¤! (ì§ˆë¬¸ 2íšŒ ì°¨ê°)`, 'ai');

                if (qCount >= maxQ) {
                    endGame(false);
                } else {
                    enableInputs();
                }
            }
        }

        function normalizeWord(word) {
            return word.toLowerCase().replace(/\s/g, '').replace(/[^ê°€-í£a-zA-Z0-9]/g, '');
        }

        // íŒíŠ¸ ê¸°ëŠ¥
        let hintCount = 0;
        const MAX_HINTS = 3;

        async function getHint() {
            if (isAsking || gameOver) return;
            if (hintCount >= MAX_HINTS) {
                addMsg(`ğŸ’¡ íŒíŠ¸ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤! (${MAX_HINTS}íšŒ ì œí•œ)`, 'system');
                return;
            }
            if (qCount >= maxQ - 1) {
                addMsg('âš ï¸ ì§ˆë¬¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'system');
                return;
            }

            isAsking = true;
            disableInputs();

            hintCount++;
            qCount += 1; // íŒíŠ¸ëŠ” ì§ˆë¬¸ 1íšŒ ì†Œëª¨
            updateQ();

            addMsg(`ğŸ’¡ íŒíŠ¸ ìš”ì²­ (${hintCount}/${MAX_HINTS})`, 'user');
            showTyping();

            try {
                const hintPrompt = `ë‹¹ì‹ ì€ ìŠ¤ë¬´ê³ ê°œ ê²Œì„ì˜ ì¶œì œìì…ë‹ˆë‹¤.
ì •ë‹µ ë‹¨ì–´: "${secretWord}"

ì‚¬ìš©ìê°€ íŒíŠ¸ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.
íŒíŠ¸ ë²ˆí˜¸: ${hintCount}ë²ˆì§¸

ê·œì¹™:
- ì •ë‹µ ë‹¨ì–´ë¥¼ ì§ì ‘ ë§í•˜ì§€ ë§ˆì„¸ìš”
- íŒíŠ¸ 1: ì¹´í…Œê³ ë¦¬ë‚˜ ëŒ€ë¶„ë¥˜ íŒíŠ¸ (ì˜ˆ: "ë™ë¬¼ì´ì—ìš”", "ë¨¹ì„ ìˆ˜ ìˆëŠ” ê²ƒì´ì—ìš”")
- íŒíŠ¸ 2: íŠ¹ì§• íŒíŠ¸ (ì˜ˆ: "ë…¸ë€ìƒ‰ì´ì—ìš”", "ë‹¤ë¦¬ê°€ 4ê°œì—ìš”")
- íŒíŠ¸ 3: ì—°ìƒ íŒíŠ¸ (ì˜ˆ: "ì •ê¸€ì˜ ì™•ì´ë¼ê³  ë¶ˆë ¤ìš”", "ì•„ì¹¨ì— ë¨¹ìœ¼ë©´ ì¢‹ì•„ìš”")
- í•œ ë¬¸ì¥ìœ¼ë¡œ ì§§ê²Œ ë‹µí•˜ì„¸ìš”

íŒíŠ¸:`;

                const res = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: hintPrompt })
                });
                if (!res.ok) throw new Error('API Error');
                const d = await res.json();

                hideTyping();
                addMsg(`ğŸ’¡ ${d.response}`, 'ai');
            } catch (e) {
                hideTyping();
                addMsg('âš ï¸ íŒíŠ¸ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'system');
                hintCount--;
                qCount--;
                updateQ();
            }

            isAsking = false;
            enableInputs();
        }

        let pendingScore = null;

        function endGame(userWon) {
            stopGameTimer();
            gameOver = true;

            data.total++;
            data.todayGames++;
            data.consecutiveGames++;

            if (userWon) {
                data.wins++; data.streak++;
                data.diffClears[difficulty]++;

                // Records
                if (!data.bestQ || qCount < data.bestQ) data.bestQ = qCount;
                const sec = getGameSec();
                if (!data.bestTime || sec < data.bestTime) data.bestTime = sec;

                // ì ìˆ˜ ì €ì¥ ëŒ€ê¸° (ë‚˜ì¤‘ì— ë‹¨ì–´ ì…ë ¥ ë°›ìŒ)
                pendingScore = {
                    questions: qCount,
                    time: getGameTime(),
                    timeSeconds: sec,
                    diff: difficulty
                };
            } else {
                data.aiWins++;
                data.streak = 0;
            }

            const newBadges = checkBadges(userWon);
            save();
            setTimeout(() => showResult(userWon, newBadges), 500);
        }

        function checkBadges(userWon) {
            const nb = [];
            if (userWon) {
                if (!data.badges.includes(difficulty)) { data.badges.push(difficulty); nb.push({ icon: DIFF[difficulty].icon, name: DIFF[difficulty].name + ' í´ë¦¬ì–´' }); }
                if (data.streak >= 3 && !data.badges.includes('streak3')) { data.badges.push('streak3'); nb.push({ icon: 'âš¡', name: '3ì—°ìŠ¹' }); if (!data.achievements.includes('streak3')) data.achievements.push('streak3'); }
                if (getGameSec() < 60 && !data.badges.includes('fast')) { data.badges.push('fast'); nb.push({ icon: 'â±ï¸', name: '1ë¶„ ë‚´ ìŠ¹ë¦¬' }); }
                if (!data.achievements.includes('first')) { data.achievements.push('first'); }
                if (qCount <= 10 && !data.achievements.includes('fast10')) { data.achievements.push('fast10'); }
                if (['easy','normal','hard','expert'].every(d => data.diffClears[d] > 0) && !data.achievements.includes('allDiff')) { data.achievements.push('allDiff'); }
            }
            if (data.consecutiveGames >= 5 && !data.badges.includes('perfect')) { data.badges.push('perfect'); nb.push({ icon: 'ğŸ¯', name: '5ê²Œì„ ì—°ì†' }); if (!data.achievements.includes('play5')) data.achievements.push('play5'); }
            return nb;
        }

        function showResult(userWon, newBadges) {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('resultScreen').style.display = 'flex';

            // ì±Œë¦°ì§€ ëª¨ë“œ ê²°ê³¼
            if (challengeMode) {
                if (userWon) {
                    let comparisonMsg = '';
                    if (challengerScore) {
                        if (qCount < challengerScore) {
                            comparisonMsg = `<br>ğŸ† <strong>${challengeFrom}ë‹˜(${challengerScore}ë²ˆ)ì„ ì´ê²¼ì–´ìš”!</strong>`;
                        } else if (qCount === challengerScore) {
                            comparisonMsg = `<br>âš–ï¸ ${challengeFrom}ë‹˜ê³¼ ë™ì !`;
                        } else {
                            comparisonMsg = `<br>ğŸ˜… ${challengeFrom}ë‹˜(${challengerScore}ë²ˆ)ì´ ë” ë¹¨ëë„¤ìš”!`;
                        }
                    }
                    document.getElementById('resultIcon').textContent = 'ğŸ‰';
                    document.getElementById('resultTitle').textContent = 'ì •ë‹µ!';
                    document.getElementById('resultSubtitle').innerHTML = `"<strong>${secretWord}</strong>"ë¥¼ ${qCount}ë²ˆ ë§Œì— ë§ì·„ì–´ìš”!${comparisonMsg}`;
                } else {
                    document.getElementById('resultIcon').textContent = 'ğŸ˜¢';
                    document.getElementById('resultTitle').textContent = 'ì•„ì‰¬ì›Œìš”!';
                    let failMsg = `ì •ë‹µì€ "<strong>${secretWord}</strong>"ì´ì—ˆì–´ìš”!`;
                    if (challengerScore) {
                        failMsg += `<br>${challengeFrom}ë‹˜ì€ ${challengerScore}ë²ˆ ë§Œì— ë§ì·„ì–´ìš”!`;
                    }
                    document.getElementById('resultSubtitle').innerHTML = failMsg;
                }
                document.getElementById('resultTitle').className = `result-title ${userWon ? 'win' : 'lose'}`;
            } else {
                document.getElementById('resultIcon').textContent = userWon ? 'ğŸ‰' : 'ğŸ˜¢';
                document.getElementById('resultTitle').textContent = userWon ? 'ì •ë‹µ!' : 'ì•„ì‰¬ì›Œìš”!';
                document.getElementById('resultTitle').className = `result-title ${userWon ? 'win' : 'lose'}`;
                document.getElementById('resultSubtitle').innerHTML = userWon
                    ? `"<strong>${secretWord}</strong>"ë¥¼ ${qCount}ë²ˆ ë§Œì— ë§ì·„ì–´ìš”!`
                    : `ì •ë‹µì€ "<strong>${secretWord}</strong>"ì´ì—ˆì–´ìš”!`;
            }

            const be = document.getElementById('badgeEarned');
            if (newBadges.length) {
                be.classList.remove('hidden');
                document.getElementById('badgeIcon').textContent = newBadges[0].icon;
                document.getElementById('badgeText').textContent = newBadges[0].name + ' íšë“!';
            } else { be.classList.add('hidden'); }

            document.getElementById('resQ').textContent = qCount;
            document.getElementById('resTime').textContent = getGameTime();
            document.getElementById('resDiff').innerHTML = `<span class="difficulty-badge difficulty-${DIFF[difficulty].cls}">${DIFF[difficulty].name}</span>`;

            // ì¹œêµ¬ ë„ì „ì¥ ë²„íŠ¼ì€ ìœ ì €ê°€ ì´ê²¼ì„ ë•Œë§Œ í‘œì‹œ
            const challengeShareSection = document.getElementById('challengeShareSection');
            if (userWon) {
                challengeShareSection.style.display = 'block';
                document.getElementById('challengeTaunt').textContent = `ğŸ”¥ ë‚˜ëŠ” ${qCount}ë²ˆ ë§Œì— ë§ì·„ë‹¤!`;
                createConfetti();
            } else {
                challengeShareSection.style.display = 'none';
            }

            // ìœ ì €ê°€ ì´ê²¼ì„ ë•Œ ì ìˆ˜ ë“±ë¡ ëª¨ë‹¬ í‘œì‹œ (ì±Œë¦°ì§€ ëª¨ë“œ ì•„ë‹ ë•Œë§Œ)
            if (userWon && pendingScore && !challengeMode) {
                setTimeout(() => showScoreModal(), 1500);
            }

            // ì±Œë¦°ì§€ ëª¨ë“œ ì¢…ë£Œ í›„ ì´ˆê¸°í™” (secretWordëŠ” ê³µìœ ë¥¼ ìœ„í•´ ìœ ì§€)
            if (challengeMode) {
                challengeMode = false;
                challengeWord = null;
                challengeFrom = null;
            }
        }

        // ì¹œêµ¬ì—ê²Œ ê°™ì€ ë‹¨ì–´ë¡œ ë„ì „ì¥ ë³´ë‚´ê¸°
        function challengeFriendWithSameWord() {
            if (!secretWord) {
                alert('ë¨¼ì € ê²Œì„ì„ í”Œë ˆì´í•´ì£¼ì„¸ìš”!');
                return;
            }

            let nickname = localStorage.getItem('tq_nickname');
            if (!nickname) {
                nickname = 'ìµëª…' + Math.floor(Math.random() * 1000);
                localStorage.setItem('tq_nickname', nickname);
            }

            // ë§í¬ ìƒì„± (Base64 ì¸ì½”ë”©)
            const encoded = btoa(encodeURIComponent(JSON.stringify({
                w: secretWord,
                f: nickname,
                d: difficulty,
                q: qCount // ë‚´ê°€ ë§ì¶˜ ì§ˆë¬¸ ìˆ˜
            })));
            challengeLink = `${window.location.origin}${window.location.pathname}?c=${encoded}`;

            // ë³µì‚¬ í›„ ì•ˆë‚´
            navigator.clipboard.writeText(challengeLink).then(() => {
                showSuccessToast('ğŸ“‹ ë„ì „ì¥ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(() => {
                // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ë§í¬ ëª¨ë‹¬ í‘œì‹œ
                showChallengeLinkModal();
            });
        }

        function createConfetti() {
            const c = document.getElementById('confetti');
            c.innerHTML = '';
            const colors = ['#6366f1','#a855f7','#22c55e','#f59e0b','#ef4444','#3b82f6'];
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.className = 'confetti';
                p.style.left = Math.random()*100 + '%';
                p.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                p.style.animationDelay = Math.random()*2 + 's';
                p.style.animationDuration = (Math.random()*2+2) + 's';
                c.appendChild(p);
            }
            setTimeout(() => { c.innerHTML = ''; }, 4000);
        }

        function shareTwitter() {
            const t = `AI ìŠ¤ë¬´ê³ ê°œì—ì„œ ${qCount}ë²ˆ ë§Œì— ${data.wins > data.aiWins ? 'ì´ê²¼ì–´ìš”' : 'ë„ì „í–ˆì–´ìš”'}! ğŸ¤”`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(t)}&url=${encodeURIComponent(location.href)}`, '_blank');
        }
        function shareKakao() { copyResult(); alert('ë³µì‚¬ë¨! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”.'); }
        function copyResult() {
            const t = `ğŸ¤” AI ìŠ¤ë¬´ê³ ê°œ\n${DIFF[difficulty].name} Â· ${qCount}ë²ˆ Â· ${getGameTime()}\n${location.href}`;
            navigator.clipboard.writeText(t).then(() => alert('ë³µì‚¬ë¨!')).catch(() => alert('ì‹¤íŒ¨'));
        }

        function playAgain() {
            sessionNum++;
            document.getElementById('resultScreen').style.display = 'none';
            startGame();
        }

        function goToStart() {
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('gameTab').classList.remove('hidden');
            document.getElementById('mainTabs').classList.remove('hidden');

            // ì±Œë¦°ì§€ ëª¨ë“œ ì´ˆê¸°í™”
            document.getElementById('challengeBanner').classList.add('hidden');
            document.querySelector('.game-mode-buttons').style.display = 'flex';
            challengeMode = false;
            challengeWord = null;
            challengeFrom = null;

            sessionNum = 1;
            data.consecutiveGames = 0;
            save();
            updateUI();
            renderLeaderboard();
            renderAchievements();
        }

        // AI Call - ìœ ì €ì˜ ì§ˆë¬¸ì— ì˜ˆ/ì•„ë‹ˆì˜¤ë¡œ ë‹µë³€
        async function callAI(question) {
            const conv = history.map(h => h.role === 'ai' ? `AI: ${h.content}` : `ì§ˆë¬¸: ${h.content}`).join('\n');

            const wordLength = secretWord.length;
            const prompt = `ë‹¹ì‹ ì€ ìŠ¤ë¬´ê³ ê°œ ê²Œì„ì˜ ì¶œì œìì…ë‹ˆë‹¤.
ì •ë‹µ ë‹¨ì–´: "${secretWord}" (${wordLength}ê¸€ì)

ì¤‘ìš”í•œ ì‚¬ì‹¤:
- ì´ ë‹¨ì–´ëŠ” ì •í™•íˆ ${wordLength}ê¸€ìì…ë‹ˆë‹¤
- ê¸€ì ìˆ˜ë¥¼ ë¬¼ìœ¼ë©´ ì •í™•í•˜ê²Œ "${wordLength}ê¸€ìì—ìš”"ë¼ê³  ë‹µí•˜ì„¸ìš”

ê·œì¹™:
- ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— "ì˜ˆ" ë˜ëŠ” "ì•„ë‹ˆì˜¤"ë¡œë§Œ ë‹µí•˜ì„¸ìš”
- ì •ë‹µ ë‹¨ì–´ë¥¼ ì ˆëŒ€ ì§ì ‘ ë§í•˜ì§€ ë§ˆì„¸ìš”
- ì§ˆë¬¸ì´ ì• ë§¤í•˜ë©´ "ê¸€ì„ìš”, ë‹¤ë¥´ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”"ë¼ê³  ë‹µí•˜ì„¸ìš”
- ë‹µë³€ì€ í•œ ë¬¸ì¥ìœ¼ë¡œ ì§§ê²Œ
- ì‚¬ì‹¤ì— ê¸°ë°˜í•´ì„œ ì •í™•í•˜ê²Œ ë‹µí•˜ì„¸ìš”

ì´ì „ ëŒ€í™”:
${conv}

ì‚¬ìš©ì ì§ˆë¬¸: "${question}"

ë‹µë³€:`;

            const res = await fetch(WORKER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            if (!res.ok) throw new Error('API Error');
            const d = await res.json();
            return d.response;
        }

        // Modal
        function confirmStartGame() {
            document.getElementById('startConfirmModal').classList.remove('hidden');
        }

        function closeStartConfirmModal() {
            document.getElementById('startConfirmModal').classList.add('hidden');
        }

        function confirmNewGame() {
            if (gameOver) {
                goToStart();
            } else {
                document.getElementById('confirmModal').classList.remove('hidden');
            }
        }

        function closeModal() { document.getElementById('confirmModal').classList.add('hidden'); }

        function newGame() {
            closeModal();
            stopGameTimer();
            resetAnswerTimer();
            goToStart();
        }

        document.getElementById('confirmModal').addEventListener('click', e => { if (e.target.id === 'confirmModal') closeModal(); });
        document.getElementById('nicknameModal').addEventListener('click', e => { if (e.target.id === 'nicknameModal') closeNicknameModal(); });
        document.getElementById('scoreModal').addEventListener('click', e => { if (e.target.id === 'scoreModal') closeScoreModal(); });
        document.getElementById('startConfirmModal').addEventListener('click', e => { if (e.target.id === 'startConfirmModal') closeStartConfirmModal(); });
        document.getElementById('challengeModal').addEventListener('click', e => { if (e.target.id === 'challengeModal') closeChallengeModal(); });
        document.getElementById('challengeLinkModal').addEventListener('click', e => { if (e.target.id === 'challengeLinkModal') closeChallengeLinkModal(); });
        document.getElementById('challengeWordInput').addEventListener('keypress', e => { if (e.key === 'Enter') createChallenge(); });

        // Enter í‚¤ë¡œ ë‹‰ë„¤ì„ ì €ì¥
        document.getElementById('nicknameInput').addEventListener('keypress', e => { if (e.key === 'Enter') saveNickname(); });
        document.getElementById('questionInput').addEventListener('keypress', e => { if (e.key === 'Enter') askQuestion(); });
        document.getElementById('guessInput').addEventListener('keypress', e => { if (e.key === 'Enter') submitGuess(); });
        document.getElementById('guessModal').addEventListener('click', e => { if (e.target.id === 'guessModal') closeGuessModal(); });

        init();
    </script>
</body>
</html>
